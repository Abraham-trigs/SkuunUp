generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MODERATOR
  PRINCIPAL
  VICE_PRINCIPAL
  TEACHER
  ASSISTANT_TEACHER
  COUNSELOR
  LIBRARIAN
  EXAM_OFFICER
  FINANCE
  HR
  RECEPTIONIST
  IT_SUPPORT
  TRANSPORT
  NURSE
  COOK
  CLEANER
  SECURITY
  MAINTENANCE
  STUDENT
  CLASS_REP
  PARENT
  ALUMNI
  AUDITOR
}

model School {
  id        String   @id @default(cuid())
  name      String   @unique
  domain    String   @unique // default domain for generating emails
  email     String   @unique // school's main contact email
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users      User[]
  classes    Class[]
  buses      Bus[]
  finances   Finance[]
  activities Activity[]
  resources  Resource[]
  Book       Book[]
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      Role
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student      Student?
  staff        Staff?
  LibraryStaff LibraryStaff?

  createdSubjects Subject[]
}

model Student {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id])
  classId    String?
  class      Class?   @relation(fields: [classId], references: [id])
  enrolledAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  exams        Exam[]
  parents      Parent[]
  transactions Transaction[]
  purchases    Purchase[]
  attendances  StudentAttendance[]
  borrows      Borrow[]

  subjects Subject[] @relation("StudentSubjects") // many-to-many with Subject
}

model Class {
  id       String    @id @default(cuid())
  name     String
  schoolId String
  school   School    @relation(fields: [schoolId], references: [id])
  students Student[]
  staff    Staff[]
  exams    Exam[] // Fixed: opposite relation for Exam.class
  subjects Subject[] @relation("ClassSubjects") // Fixed: opposite of Subject.classes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, schoolId])
}

model Subject {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Make createdById nullable initially to avoid breaking existing rows
  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  exams    Exam[]
  staff    Staff[]   @relation("StaffSubjects")
  students Student[] @relation("StudentSubjects") // many-to-many
  classes  Class[]   @relation("ClassSubjects") // many-to-many
}

model Exam {
  id        String   @id @default(cuid())
  studentId String?
  student   Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classId   String?
  class     Class?   @relation(fields: [classId], references: [id])
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  score     Float?
  maxScore  Float?
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Staff {
  id           String      @id @default(cuid())
  userId       String      @unique
  user         User        @relation(fields: [userId], references: [id])
  classId      String?
  class        Class?      @relation(fields: [classId], references: [id])
  position     String?
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  salary       Float?
  hireDate     DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  subjects    Subject[]         @relation("StaffSubjects") // optional: subjects they teach
  attendances StaffAttendance[]
}

model Department {
  id           String         @id @default(cuid())
  name         String         @unique
  staff        Staff[]
  LibraryStaff LibraryStaff[]
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

model StudentAttendance {
  id        String           @id @default(cuid())
  studentId String
  student   Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  date      DateTime         @default(now())
  status    AttendanceStatus
  timeIn    DateTime?
  timeOut   DateTime?
  remarks   String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([studentId, date], name: "studentId_date")
}

model StaffAttendance {
  id        String           @id @default(cuid())
  staffId   String
  staff     Staff            @relation(fields: [staffId], references: [id], onDelete: Cascade)
  date      DateTime         @default(now())
  status    AttendanceStatus
  timeIn    DateTime?
  timeOut   DateTime?
  remarks   String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

model Parent {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  name      String
  email     String   @unique
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// prisma/library.prisma
// Library management models integrated with Department and School

model Author {
  id        String   @id @default(cuid())
  name      String
  bio       String?
  books     Book[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id        String   @id @default(cuid())
  name      String
  books     Book[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Book {
  id          String    @id @default(cuid())
  title       String
  isbn        String    @unique
  authorId    String
  author      Author    @relation(fields: [authorId], references: [id])
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  totalCopies Int       @default(1)
  available   Int       @default(1)
  schoolId    String
  school      School    @relation(fields: [schoolId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  borrows Borrow[]
}

model Borrow {
  id         String    @id @default(cuid())
  bookId     String
  book       Book      @relation(fields: [bookId], references: [id])
  studentId  String
  student    Student   @relation(fields: [studentId], references: [id], onDelete: Cascade) // ✅ added
  borrowedAt DateTime  @default(now())
  dueAt      DateTime
  returnedAt DateTime?
  fine       Float     @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([bookId, studentId, borrowedAt], name: "unique_borrow")
}

model LibraryStaff {
  id           String     @id @default(cuid())
  userId       String     @unique
  user         User       @relation(fields: [userId], references: [id])
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  position     String?
  hireDate     DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

//TRANSACTION

enum FinanceType {
  INCOME
  EXPENSE
}

enum FeeType {
  TUITION
  EXAM
  LAB
  SPORTS
  LIBRARY
  TRANSPORT
  UNIFORM
  OTHER
}

//FINANCE 

model Transaction {
  id          String      @id @default(cuid())
  studentId   String
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  type        FinanceType @default(INCOME)
  feeType     FeeType?
  amount      Float
  date        DateTime    @default(now())
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Finance {
  id          String      @id @default(cuid())
  schoolId    String
  school      School      @relation(fields: [schoolId], references: [id])
  type        FinanceType @default(INCOME)
  amount      Float
  description String?
  date        DateTime    @default(now())
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Resource {
  id        String   @id @default(cuid())
  name      String
  category  String?
  unitPrice Float
  quantity  Int      @default(1)
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases Purchase[]

  @@unique([name, schoolId])
}

model Purchase {
  id         String   @id @default(cuid())
  studentId  String
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade) // ✅ added
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])
  quantity   Int      @default(1)
  totalCost  Float
  date       DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

//SCHOOL SCOPE

model Activity {
  id          String   @id @default(cuid())
  title       String
  description String?
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Bus {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  plateNumber String   @unique
  driverName  String
  capacity    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
